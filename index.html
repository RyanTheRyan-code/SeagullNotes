<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SeagullNotes</title>
  <script src="config.js"></script>
</head>
<body>
  <div id="app">
    <div id="settings" style="margin-bottom: 1em;">
      <label>GitHub token (stored in browser only): <input type="password" id="tokenInput" placeholder="Paste token here"></label>
      <button type="button" id="saveTokenBtn">Save token</button>
      <button type="button" id="logoutBtn">Log out</button>
    </div>
    <div>
      <label>Filename: <input type="text" id="filenameInput" placeholder="note-YYYY-MM-DD-HHmm.txt"></label>
    </div>
    <div style="margin-top: 0.5em;">
      <textarea id="noteText" rows="15" cols="80" placeholder="Your note..."></textarea>
    </div>
    <div style="margin-top: 0.5em;">
      <button type="button" id="saveBtn">Save</button>
      <span id="status"></span>
    </div>
  </div>

  <script>
    (function () {
      var TOKEN_KEY = 'github_token';
      var REPO_OWNER = typeof CONFIG !== 'undefined' && CONFIG.REPO_OWNER ? CONFIG.REPO_OWNER : 'YOUR_GITHUB_USERNAME';
      var REPO_NAME = typeof CONFIG !== 'undefined' && CONFIG.REPO_NAME ? CONFIG.REPO_NAME : 'privateNotes';

      function getToken() {
        return localStorage.getItem(TOKEN_KEY);
      }

      function setToken(value) {
        if (value && value.trim()) {
          localStorage.setItem(TOKEN_KEY, value.trim());
          document.getElementById('tokenInput').value = '';
          showStatus('Token saved.', true);
        }
      }

      function clearToken() {
        localStorage.removeItem(TOKEN_KEY);
        document.getElementById('tokenInput').value = '';
        document.getElementById('noteText').value = '';
        showStatus('Logged out.', true);
      }

      function defaultFilename() {
        var now = new Date();
        var y = now.getFullYear();
        var m = String(now.getMonth() + 1).padStart(2, '0');
        var d = String(now.getDate()).padStart(2, '0');
        var h = String(now.getHours()).padStart(2, '0');
        var min = String(now.getMinutes()).padStart(2, '0');
        return 'note-' + y + '-' + m + '-' + d + '-' + h + min + '.txt';
      }

      function base64Utf8(text) {
        return btoa(unescape(encodeURIComponent(text)));
      }

      function showStatus(msg, isOk) {
        var el = document.getElementById('status');
        el.textContent = msg;
        el.style.color = isOk ? 'green' : 'red';
      }

      function saveNote() {
        var token = getToken();
        if (!token) {
          var fromPrompt = prompt('Paste your GitHub Personal Access Token (it will be stored in this browser only):');
          if (fromPrompt && fromPrompt.trim()) {
            setToken(fromPrompt);
            token = getToken();
          }
          if (!token) {
            showStatus('Need a token to save. Paste it above or in the prompt.', false);
            return;
          }
        }

        var filename = document.getElementById('filenameInput').value.trim();
        if (!filename) {
          filename = defaultFilename();
          document.getElementById('filenameInput').value = filename;
        }
        if (!filename.endsWith('.txt')) {
          filename += '.txt';
        }

        var noteText = document.getElementById('noteText').value;
        var path = 'notes/' + filename;

        var url = 'https://api.github.com/repos/' + REPO_OWNER + '/' + REPO_NAME + '/contents/' + path;
        var body = {
          message: 'Add note: ' + filename,
          content: base64Utf8(noteText)
        };

        fetch(url, { headers: { 'Authorization': 'Bearer ' + token, 'Accept': 'application/vnd.github+json' } })
          .then(function (getRes) {
            if (getRes.ok) {
              return getRes.json().then(function (data) { body.sha = data.sha; });
            }
          })
          .then(function () {
            return fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        })
          .then(function (res) {
            if (res.ok) {
              showStatus('Saved.', true);
              return;
            }
            return res.json().then(function (data) {
              showStatus(data.message || 'Save failed.', false);
            });
          })
          .catch(function (err) {
            showStatus('Error: ' + err.message, false);
          });
          });
      }

      document.getElementById('filenameInput').placeholder = defaultFilename();

      document.getElementById('saveTokenBtn').addEventListener('click', function () {
        var v = document.getElementById('tokenInput').value;
        setToken(v);
      });

      document.getElementById('logoutBtn').addEventListener('click', function () {
        clearToken();
      });

      document.getElementById('saveBtn').addEventListener('click', saveNote);
    })();
  </script>
</body>
</html>
